---
title: "Deforestation"
author: "Hollie Rawlings"
date: "11/05/2021"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("tidytuesdayR")
library(shiny)
library(tidyverse)
library(plotly)
library(janitor)
```

### Data call###
```{r}
#tuesdata <- tidytuesdayR::tt_load('2021-04-06')

#forest_data <- tuesdata$forest
#forest_area_data <-tuesdata$forest_area
#brazil_forest_loss <-tuesdata$brazil_loss
soybean_farming <-tuesdata$soybean_use
#vegtable_oil <-tuesdata$vegetable_oil
```

###Ideas###
1. A map of forest loss by country filterable by year (I have never done a map in R before)
2. Tree map (because we like those) of soybean use filterable by year and faceted by continent (means i will need to join in a continent list)
3. Forecast of future rainforest loss in Brazil for the next 10 years. 

###Source###
paper is here: https://ourworldindata.org/forests-and-deforestation


### Tree map showing the changes in soybean use by continet over time
1. I don't like how they have grouped continents in this code so I am joining my own list in
source is here: https://pkgstore.datahub.io/JohnSnowLabs/country-and-continent-codes-list/country-and-continent-codes-list-csv_csv/data/b7876b7f496677669644f3d1069d3121/country-and-continent-codes-list-csv_csv.csv

2. Next I look for a primary key iD to join the two on, in this case its the 3 letter code, I do an inner join so that all the things I don't want in soybean_farming are not included. Then Ill select what we need. 

3. Some countries exist in two continents Ill create a list of allocations so I can see where it is going wrong. 
4. Then I mutate the continent with case_when to give it one allocation
```{r}
continent_list <-read.csv("Continent_list.csv")

soybean_farming <- soybean_farming %>% 
                                      inner_join(continent_list,by=c("code"="Three_Letter_Country_Code"))%>%
                                      select(entity,code,year,human_food,animal_feed,processed,`ï..Continent_Name`)%>%
                                      rename(Continent=`ï..Continent_Name`)

continent_allocation <- soybean_farming %>% select(entity,Continent)%>%
                                                                        unique()
## These countries are 	Armenia,Azerbaijan,Cyprus,Georgia,Kazakhstan,Russia,Turkey 
## There are not many, so I can use a case when to recode them. 
## I'm no geography expert so I may not be right, If this were go go in a paper I would have to include a footnote about these allocations

soybean_farming <- soybean_farming %>% 
                                      mutate(Continent = case_when(
                                        entity == "Armenia" ~ "Europe",
                                        entity == "Azerbaijan" ~ "Asia", 
                                        entity == "Cyprus" ~ "Europe", 
                                        entity == "Georgia" ~ "Asia", 
                                        entity == "Kazakhstan" ~ "Asia", 
                                        entity == "Russia" ~ "Europe", 
                                        entity == "Turkey" ~ "Europe", 
                                        TRUE ~ Continent
                                        ))%>%
                                        unique()



```

## Data processing for suburst chart 
1. As a sample to just get myself going I have limited the year to 2013
2. Eventually year will go in as a slider or dropdown in the shiny app
3. I remove everything that we don't need in the data file and re-order it specifically for the data wrangling function
```{r}
soybean_farming <- soybean_farming %>%
                                        filter(year == "2013")%>%
                                        select(-year,-code)%>%
                                        pivot_longer(cols =c(human_food,animal_feed,processed))%>%
                                        select(Continent,entity,name,value)
                                      
```

## Function 
```{r}
as.sunburstDF <- function(DF, valueCol = NULL){
  require(data.table)
  
  colNamesDF <- names(DF)
  
  if(is.data.table(DF)){
    DT <- copy(DF)
  } else {
    DT <- data.table(DF, stringsAsFactors = FALSE)
  }
  
  DT[, root := "Total"]
  colNamesDT <- names(DT)
  
  if(is.null(valueCol)){
    setcolorder(DT, c("root", colNamesDF))
  } else {
    setnames(DT, valueCol, "values", skip_absent=TRUE)
    setcolorder(DT, c("root", setdiff(colNamesDF, valueCol), "values"))
  }
  
  hierarchyCols <- setdiff(colNamesDT, "values")
  hierarchyList <- list()
  
  for(i in seq_along(hierarchyCols)){
    currentCols <- colNamesDT[1:i]
    if(is.null(valueCol)){
      currentDT <- unique(DT[, ..currentCols][, values := .N, by = currentCols], by = currentCols)
    } else {
      currentDT <- DT[, lapply(.SD, sum, na.rm = TRUE), by=currentCols, .SDcols = "values"]
    }
    setnames(currentDT, length(currentCols), "labels")
    hierarchyList[[i]] <- currentDT
  }
  
  hierarchyDT <- rbindlist(hierarchyList, use.names = TRUE, fill = TRUE)
  
  parentCols <- setdiff(names(hierarchyDT), c("labels", "values", valueCol))
  hierarchyDT[, parents := apply(.SD, 1, function(x){fifelse(all(is.na(x)), yes = NA_character_, no = paste(x[!is.na(x)], sep = ":", collapse = " - "))}), .SDcols = parentCols]
  hierarchyDT[, ids := apply(.SD, 1, function(x){paste(x[!is.na(x)], collapse = " - ")}), .SDcols = c("parents", "labels")]
  hierarchyDT[, c(parentCols) := NULL]
  return(hierarchyDT)
}
sunburstDF <- as.sunburstDF(soybean_farming, valueCol = "value")
```
### Radial treemap 


```{r}
sunburst <-plot_ly(data = sunburstDF, ids = ~ids, labels= ~labels, parents = ~parents, values= ~values, type='sunburst',maxdepth=2 ,branchvalues = 'total')
sunburst

```
##Vingete 

```{r}
d <- data.frame(
    ids = c(
    "North America", "Europe", "Australia", "North America - Football", "Soccer",
    "North America - Rugby", "Europe - Football", "Rugby",
    "Europe - American Football","Australia - Football", "Association",
    "Australian Rules", "Autstralia - American Football", "Australia - Rugby",
    "Rugby League", "Rugby Union"
  ),
  labels = c(
    "North<br>America", "Europe", "Australia", "Football", "Soccer", "Rugby",
    "Football", "Rugby", "American<br>Football", "Football", "Association",
    "Australian<br>Rules", "American<br>Football", "Rugby", "Rugby<br>League",
    "Rugby<br>Union"
  ),
  parents = c(
    "", "", "", "North America", "North America", "North America", "Europe",
    "Europe", "Europe","Australia", "Australia - Football", "Australia - Football",
    "Australia - Football", "Australia - Football", "Australia - Rugby",
    "Australia - Rugby"
  ),
  stringsAsFactors = FALSE
)

fig <- plot_ly(d, ids = ~ids, labels = ~labels, parents = ~parents, type = 'sunburst')

fig
```

```{r}
library(plotly)

d1 <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/coffee-flavors.csv')
d2 <- read.csv('https://raw.githubusercontent.com/plotly/datasets/718417069ead87650b90472464c7565dc8c2cb1c/sunburst-coffee-flavors-complete.csv')
fig <- plot_ly() 
fig <- fig %>%
  add_trace(
    ids = d1$ids,
    labels = d1$labels,
    parents = d1$parents,
    type = 'sunburst',
    maxdepth = 2,
    domain = list(column = 0)
    ) 
fig <- fig %>%
  add_trace(
    ids = d2$ids,
    labels = d2$labels,
    parents = d2$parents,
    type = 'sunburst',
    maxdepth = 3,
    domain = list(column = 1)
  ) 
fig <- fig %>%
    layout(
      grid = list(columns =2, rows = 1),
      margin = list(l = 0, r = 0, b = 0, t = 0),
      sunburstcolorway = c(
        "#636efa","#EF553B","#00cc96","#ab63fa","#19d3f3",
        "#e763fa", "#FECB52","#FFA15A","#FF6692","#B6E880"
      ),
      extendsunburstcolors = TRUE)
fig


```

```{r}
df = read.csv('https://raw.githubusercontent.com/plotly/datasets/718417069ead87650b90472464c7565dc8c2cb1c/coffee-flavors.csv')

fig <- plot_ly()

fig <- fig %>% add_trace(
  type='sunburst',
  ids=df$ids,
  labels=df$labels,
  parents=df$parents,
  domain=list(column=1),
  maxdepth=2,
  insidetextorientation='radial'
)
fig
```