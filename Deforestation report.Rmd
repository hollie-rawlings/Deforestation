---
title: "The effect of Soy production on Deforestaion"
author: "Hollie Rawlings"
date: "18/05/2021"
output: 
  html_notebook: 
    theme: united
    toc: true
    toc_float: true
    number_sections: true
runtime: shiny
---

```{r include=FALSE,message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(shiny)
library(tidyverse)
library(plotly)
library(janitor)
library(data.table)
library(shinythemes)
library(hrbrthemes)
library(magrittr)
library(rvest)
library(maps)
library(ggiraph)
library(RColorBrewer)
library(gridExtra)

#tuesdata <- tidytuesdayR::tt_load('2021-04-06')

#forest_data <- tuesdata$forest
#forest_area_data <-tuesdata$forest_area
#brazil_forest_loss <-tuesdata$brazil_loss
#soybean_farming <-tuesdata$soybean_use
#vegtable_oil <-tuesdata$vegetable_oil

soybean_farming<- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-06/soybean_use.csv')
```
# Introduction {-}

Across the world, demand for soy and soy products is surging. 
Soy production has increased 15 fold since 1950 and is driven by four main countries, Brazil, Argentina, China and the US. 
In recent years, soy has earned a poor reputation for both health and sustainability, but is this reputation justified? 

This report will look at the history of soy production, investigate its links to deforestation and to think about what the future of soy production looks like in a  sustainable world. 



# The ever changing demand for soy products {-}


- Shiny widget showing the radial treemap so a user can interact better with the data

```{r echo=FALSE}
continent_list <-read.csv("Continent_list.csv")

soybean_farming <- soybean_farming %>% 
  inner_join(continent_list,by=c("code"="Three_Letter_Country_Code"))%>%
  select(entity,code,year,human_food,animal_feed,processed,`ï..Continent_Name`)%>%
  rename(Continent=`ï..Continent_Name`)

continent_allocation <- soybean_farming %>% select(entity,Continent)%>%
  unique()
## These countries are 	Armenia,Azerbaijan,Cyprus,Georgia,Kazakhstan,Russia,Turkey 
## There are not many, so I can use a case when to recode them. 
## I'm no geography expert so I may not be right, If this were go go in a paper I would have to include a footnote about these allocations

soybean_farming <- soybean_farming %>% 
  mutate(Continent = case_when(
    entity == "Armenia" ~ "Europe",
    entity == "Azerbaijan" ~ "Asia", 
    entity == "Cyprus" ~ "Europe", 
    entity == "Georgia" ~ "Asia", 
    entity == "Kazakhstan" ~ "Asia", 
    entity == "Russia" ~ "Europe", 
    entity == "Turkey" ~ "Europe", 
    TRUE ~ Continent
  ))%>%
  unique()


## Function for building enginering data into the sunburst plot (its a real pain to get data in this format, ill keep note of this for the future) 

source(file = 'as_sunburst.R')

```

```{r,echo=FALSE}
#https://stackoverflow.com/questions/57064828/how-can-i-change-colors-of-segments-in-trace
#https://plotly.com/r/sunburst-charts/

# Might eb able to give a continent number and then 
ui <- fluidPage(
  theme = shinytheme("united"),
  sidebarLayout(
    sidebarPanel(
      selectInput("years", label = h3("Select box"), 
            choices = list("1965" = 1965, "1970" = 1970,"1975"=1975,"1980"=1980, "1985"=1985,"1990"=1990,"1995"=1995,"2000"=2000,"2005"=2005,"2010"=2010), 
            selected = 1990)),
    mainPanel(
    plotlyOutput("radialtree"))
      )
        )

server <- function(input, output, session){
reactive_soybean_farming_sun <- reactive({ 
                                        soybean_farming %>%
                                        filter(year ==input$years)%>%
                                        select(-code)%>%
                                        pivot_longer(cols =c(human_food,animal_feed,processed))%>%
                                        filter(value != 0)%>%
                                        select(Continent,entity,name,value)%>%
                                        as.sunburstDF(.,valueCol = "value")%>%
                                        mutate(color = case_when(
                                          str_detect(ids,"Europe") ~ "#ACDF87", 
                                          str_detect(ids,"Asia") ~ "#1E5631",
                                          str_detect(ids,"North America") ~ "#A4DE02",
                                          str_detect(ids,"South America") ~ "#D2E95E",
                                          str_detect(ids,"Africa") ~ "#4C9A2A",
                                          str_detect(ids,"Oceania") ~ "#15AA66",
                                          TRUE ~ "NA"
                                        ))
## somehow need to change colours
})

output$radialtree <-renderPlotly({
  
  
plot_ly(data = reactive_soybean_farming_sun(), ids = ~ids, labels= ~labels, parents = ~parents, values= ~values ,type='sunburst',maxdepth=2 ,branchvalues = 'total',insidetextorientation='radial',marker = list(colors= ~color))%>% layout(title = 'Soybean production by country')
})



}

shinyApp(ui, server)


```
- Shiny widget showing demand for soy production over time split out by country (maybe an area chart?)

```{r}
soybean_farming 

ui =    fluidPage(
            theme = shinytheme("united"),
            sidebarLayout(
                sidebarPanel(

                                sliderInput("years_slide",
                                label = "Years",
                                min = 1961,
                                max = 2013,
                                value = c(2000,2010))
                ),
            mainPanel(
              plotlyOutput('areachart')
            ) 

))
  
server = function(input, output, session){
  reactive_soybean_farming_area <- reactive({ 
                                        soybean_farming %>%
                                        mutate(across(human_food:processed, ~replace_na(.x,0)))%>%
                                        filter(.,between(year,input$years_slide[1],input$years_slide[2]))%>%
                                        select(-code)%>%
                                        group_by(Continent,year)%>%
                                        mutate(Total = sum(human_food ,animal_feed,processed))%>%
                                        ungroup()%>%
                                        select(-entity,-human_food,-animal_feed,-processed)%>%
                                        unique()
})         
  output$areachart <- renderPlotly({
  ggplotly(
    ggplot(reactive_soybean_farming_area(), aes(x=year,y=Total,fill=Continent)) +
    geom_area() +
      theme(legend.position="none") +
    ggtitle("Total soy production by continent") +
    scale_fill_manual(values=c("#4C9A2A", "#1E5631", "#ACDF87","#A4DE02","#15AA66","#D2E95E")) +
    theme_minimal() + 
    theme(legend.position="none")
  )
})
}

shinyApp(ui, server)
```
# Is soy production linked to deforestaion? {-}

- Shiny widget map showing soy production hot-spots over time (maybe animated?)
```{r,echo=FALSE}
soybean_farming_data<- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-06/soybean_use.csv')

ui =  fluidPage(
          theme = shinytheme("united"),
          sidebarLayout(
              sidebarPanel(

                            sliderInput("years_slide",
                            label = "Years",
                            min = 1961,
                            max = 2013,
                            value = c(2000)),
                            
                            selectInput("consumption", label = h3("Select box"), 
                            choices = list("Human Food" = "human_food", "Direct animal feed" = "animal_feed",
                            "Processed products" = "processed"), selected = 1)
                ),
            mainPanel(
              plotlyOutput('world_map')
            ) 
))
server <- function(input, output) {


  
soybean_farming_map_data <- reactive({
                                      soybean_farming_data %>%
                                                        filter(!is.na(code))%>%
                                                        filter(year==input$years_slide)%>%
                                                        pivot_longer(cols=human_food:processed,names_to="type",values_to="value")
})

soybean_farming_map_data_2 <- reactive({   
                                            soybean_farming_map_data() %>%
                                                                        subset(type %in% input$consumption)

})


output$world_map <-renderPlotly({
data <- soybean_farming_map_data_2()
  
plot_ly(data, type='choropleth', locations=data$code, z=data$value, text=data$entity, colorscale="Blues")
})

}
shinyApp(ui, server)
```
- Shiny widget Next to graph of deforestation 
Investigate brazil data
```{r}
brazil_loss <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-06/brazil_loss.csv')

ui =    fluidPage(
            theme = shinytheme("united"),
            sidebarLayout(
                sidebarPanel(

                                sliderInput("years_slide",
                                label = "Years",
                                min = 2001,
                                max = 2013,
                                value = c(2001,2005))
                ),
            mainPanel(
              plotlyOutput('areachartbrazil')
            ) 

))
  
server = function(input, output, session){
  reactive_brazil_forest_loss<- reactive({ 
                                        brazil_loss %>%
                                        filter(.,between(year,input$years_slide[1],input$years_slide[2]))%>%
                                        pivot_longer(cols=commercial_crops:small_scale_clearing,names_to="type",values_to="value")
})         
  output$areachartbrazil <- renderPlotly({
  ggplotly(
    ggplot(reactive_brazil_forest_loss(), aes(x=year,y=value,fill=type)) +
    geom_area() +
      theme(legend.position="none") +
    ggtitle("Causes of Forest loss in Brazil") +
    theme_ipsum() +
    theme(legend.position="right")
  )
})
}

shinyApp(ui, server)
```
# What does the future of soy production look like? {-}
- Shiny widget forecast of future soy need 
- What can we do to protect our forests worldwide? 
```{r include=FALSE}
## Bit of a data explore to find a suitable prediction model

soybean_farming<- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-06/soybean_use.csv')
library(caret)

soybean_farming <- soybean_farming %>% 
  inner_join(continent_list,by=c("code"="Three_Letter_Country_Code"))%>%
  select(entity,code,year,human_food,animal_feed,processed,`ï..Continent_Name`)%>%
  rename(Continent=`ï..Continent_Name`)

continent_allocation <- soybean_farming %>% select(entity,Continent)%>%
  unique()
## These countries are 	Armenia,Azerbaijan,Cyprus,Georgia,Kazakhstan,Russia,Turkey 
## There are not many, so I can use a case when to recode them. 
## I'm no geography expert so I may not be right, If this were go go in a paper I would have to include a footnote about these allocations

soybean_farming <- soybean_farming %>% 
  mutate(Continent = case_when(
    entity == "Armenia" ~ "Europe",
    entity == "Azerbaijan" ~ "Asia", 
    entity == "Cyprus" ~ "Europe", 
    entity == "Georgia" ~ "Asia", 
    entity == "Kazakhstan" ~ "Asia", 
    entity == "Russia" ~ "Europe", 
    entity == "Turkey" ~ "Europe", 
    TRUE ~ Continent
  ))%>%
  unique()

human <-ggplot(soybean_farming,aes(x=year,y=human_food,color=entity))+
  geom_line()+
  theme(legend.position = "none")

animal <-ggplot(soybean_farming,aes(x=year,y=animal_feed,color=entity))+
  geom_line()+
  theme(legend.position = "none")

processed <-ggplot(soybean_farming,aes(x=year,y=processed,color=entity))+
  geom_line()+
  theme(legend.position = "none")

grid.arrange(human, animal,processed,nrow = 3)
```
Predictions for the future 
- make individual predictions for each country 
- split each model up

```{r include=FALSE}
library(forecast)
library(xts)
## Humans
human_split <- soybean_farming %>% 
                select(-processed,-animal_feed)
human_split$entity <-as.factor(human_split$entity)
human_split <- split(human_split,human_split$entity)


#Animals
animal_split <- soybean_farming %>% 
                select(-processed,-human_food)
animal_split$entity <-as.factor(animal_split$entity)
animal_split <- split(animal_split,animal_split$entity)


#Processed
processed_split <- soybean_farming %>% 
                select(-human_food,-animal_feed) 
processed_split$entity <-as.factor(processed_split$entity)
processed_split <- split(processed_split,processed_split$entity)

##Prediction_model
Prediction_Model <- function(data){

for(i in 1:length(data)){
data_z <- human_split[["China"]] 
data_z[is.na(data_z)] = 0
name <- unique(data_z$entity)
data_z$entity <-NULL
data_z$code <- NULL
data_z$Continent <-NULL
data_z$year <- NULL

past <- ts(data_z,end=2013)
fc <-holt(past)
x <-autoplot(fc) +
  autolayer(fitted(fc), series="Fitted") +
  ylab("Soy production (millions of tonnes)") + xlab("Year")
}
x
}

Prediction_Model(human_split)
Prediction_Model(animal_split)
Prediction_Model(processed_split)
```
- Shiny app predictions 

```{r}
ui =  fluidPage(
          theme = shinytheme("united"),
          sidebarLayout(
              sidebarPanel(
                            
                            selectInput("consumption", label = h3("Select box"), 
                            choices = list("Human Food" = "human_split", "Direct animal feed" = "animal_split",
                            "Processed products" = "processed_split"), selected = 1),
                            
                            selectInput("contry", label = h3("Select box"), 
                            choices = unique(soybean_farming$entity), selected = "Albania")
                ),
            mainPanel(
              plotOutput('plot')
            ) 
))
server = function(input, output, session){


  
datasetInput <- reactive({
  switch(input$consumption, 
         "human_split" = human_split, 
         "animal_split" = animal_split, 
         "processed_split" = processed_split)
})


filtered_data <- reactive({
  data <- datasetInput()
  data[[input$contry]]
    
})

output$plot <-renderPlot({
  data <-filtered_data()
  name <- unique(data$entity)
  data$entity <-NULL
  data$code <- NULL
  data$Continent <-NULL
  data$year <- NULL
  past <- ts(data,end=2013)
  fc <-holt(past)
  x <-autoplot(fc) +
  autolayer(fitted(fc), series="Fitted") +
  ylab("Soy production (millions of tonnes)") + xlab("Year")
  x
})


}
shinyApp(ui, server)
```
# Conclusion remarks {-}