---
title: "The effect of Soy production on Deforestaion"
author: "Hollie Rawlings"
date: "18/05/2021"
output: 
  html_notebook: 
    theme: united
    toc: true
    toc_float: true
    number_sections: true
runtime: shiny
---

```{r include=FALSE,message=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(shiny)
library(tidyverse)
library(plotly)
library(janitor)

tuesdata <- tidytuesdayR::tt_load('2021-04-06')

forest_data <- tuesdata$forest
forest_area_data <-tuesdata$forest_area
#brazil_forest_loss <-tuesdata$brazil_loss
#soybean_farming <-tuesdata$soybean_use
#vegtable_oil <-tuesdata$vegetable_oil

soybean_farming<- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-06/soybean_use.csv')
```
# Introduction {-}

Across the world, demand for soy and soy products is surging. 
Soy production has increased 15 fold since 1950 and is driven by four main countries, Brazil, Argentina, China and the US. 
In recent years, soy has earned a poor reputation for both health and sustainability, but is this reputation justified? 

This report will look at the history of soy production, investigate its links to deforestation and to think about what the future of soy production looks like in a  sustainable world. 



# The ever changing demand for soy products {-}


- Shiny widget showing the radial treemap so a user can interact better with the data

```{r echo=FALSE}
continent_list <-read.csv("Continent_list.csv")

soybean_farming <- soybean_farming %>% 
  inner_join(continent_list,by=c("code"="Three_Letter_Country_Code"))%>%
  select(entity,code,year,human_food,animal_feed,processed,`ï..Continent_Name`)%>%
  rename(Continent=`ï..Continent_Name`)

continent_allocation <- soybean_farming %>% select(entity,Continent)%>%
  unique()
## These countries are 	Armenia,Azerbaijan,Cyprus,Georgia,Kazakhstan,Russia,Turkey 
## There are not many, so I can use a case when to recode them. 
## I'm no geography expert so I may not be right, If this were go go in a paper I would have to include a footnote about these allocations

soybean_farming <- soybean_farming %>% 
  mutate(Continent = case_when(
    entity == "Armenia" ~ "Europe",
    entity == "Azerbaijan" ~ "Asia", 
    entity == "Cyprus" ~ "Europe", 
    entity == "Georgia" ~ "Asia", 
    entity == "Kazakhstan" ~ "Asia", 
    entity == "Russia" ~ "Europe", 
    entity == "Turkey" ~ "Europe", 
    TRUE ~ Continent
  ))%>%
  unique()


soybean_farming <- soybean_farming %>%
                                        filter(year == "2013")%>%
                                        select(-year,-code)%>%
                                        pivot_longer(cols =c(human_food,animal_feed,processed))%>%
                                        select(Continent,entity,name,value)


## Function for building enginering data into the sunburst plot (its a real pain to get data in this format, ill keep note of this for the future) 

as.sunburstDF <- function(DF, valueCol = NULL){
  require(data.table)
  
  colNamesDF <- names(DF)
  
  if(is.data.table(DF)){
    DT <- copy(DF)
  } else {
    DT <- data.table(DF, stringsAsFactors = FALSE)
  }
  
  DT[, root := "Total"]
  colNamesDT <- names(DT)
  
  if(is.null(valueCol)){
    setcolorder(DT, c("root", colNamesDF))
  } else {
    setnames(DT, valueCol, "values", skip_absent=TRUE)
    setcolorder(DT, c("root", setdiff(colNamesDF, valueCol), "values"))
  }
  
  hierarchyCols <- setdiff(colNamesDT, "values")
  hierarchyList <- list()
  
  for(i in seq_along(hierarchyCols)){
    currentCols <- colNamesDT[1:i]
    if(is.null(valueCol)){
      currentDT <- unique(DT[, ..currentCols][, values := .N, by = currentCols], by = currentCols)
    } else {
      currentDT <- DT[, lapply(.SD, sum, na.rm = TRUE), by=currentCols, .SDcols = "values"]
    }
    setnames(currentDT, length(currentCols), "labels")
    hierarchyList[[i]] <- currentDT
  }
  
  hierarchyDT <- rbindlist(hierarchyList, use.names = TRUE, fill = TRUE)
  
  parentCols <- setdiff(names(hierarchyDT), c("labels", "values", valueCol))
  hierarchyDT[, parents := apply(.SD, 1, function(x){fifelse(all(is.na(x)), yes = NA_character_, no = paste(x[!is.na(x)], sep = ":", collapse = " - "))}), .SDcols = parentCols]
  hierarchyDT[, ids := apply(.SD, 1, function(x){paste(x[!is.na(x)], collapse = " - ")}), .SDcols = c("parents", "labels")]
  hierarchyDT[, c(parentCols) := NULL]
  return(hierarchyDT)
}

```

```{r,echo=FALSE}
ui <- fluidPage(
  selectInput("choice", "Choose", choices = names(iris), selected = NULL),
  plotlyOutput("graph")
  )

server <- function(input, output, session){


sunburstDF <- as.sunburstDF(soybean_farming, valueCol = "value")  
renderPlotly({
  plot_ly(data = sunburstDF, ids = ~ids, labels= ~labels, parents = ~parents, values= ~values, type='sunburst',maxdepth=2 ,branchvalues = 'total')
})
}

shinyApp(ui, server)





```
- Shiny widget showing demand for soy production over time split out by country (maybe an area chart?)



# Is soy production linked to deforestaion? {-}

- Shiny widget map showing soy production hot-spots over time (maybe animated?)
- Shiny widget Next to graph of deforestation 

# What does the future of soy production look like? {-}
- Shiny widget forecast of future soy need 
- What can we do to protect our forests worldwide? 

# Conclusion remarks {-}